<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‘æ´ - ç§äººæƒ…ç»ªç©ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500&display=swap');

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Noto Serif SC', serif;
            overflow: hidden;
        }

        /* å…¨å±€èƒŒæ™¯å›¾è®¾ç½® */
        .bg-main {
            background-image: url('IMG_3004.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; /* ä¸ºå³ä¸Šè§’æŒ‰é’®æä¾›å®šä½ */
        }

        /* åŠ¨ç”»è¿‡æ¸¡ */
        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* é¦–é¡µç²‰çº¢è‰²æŒ‰é’® */
        .btn-pink {
            background-color: #E68BA0;
            color: white;
            transition: transform 0.2s, background-color 0.2s;
        }
        .btn-pink:hover {
            background-color: #d67b90;
            transform: scale(1.02);
        }

        /* è®°å½•é¡µæ–¹å½¢ç±³è‰²å®¹å™¨ */
        .beige-modal {
            background-color: #FDFBF5;
            border: 1px solid #D1C7B7;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            padding: 2.5rem;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* ===================== ğŸµ BGM UI ===================== */
        .sound-toggle {
            position: absolute;
            top: 18px;
            right: 18px;
            font-size: 22px;
            cursor: pointer;
            opacity: 0.75;
            transition: opacity 0.2s, transform 0.2s;
            user-select: none;
            z-index: 60;
        }
        .sound-toggle:hover {
            opacity: 1;
            transform: scale(1.08);
        }

        /* =====================  æ­£å¿µå‘¼å¸ Overlay ===================== */
        #mindfulness-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
        }

        .mind-bg {
            position: absolute;
            inset: 0;
            transition: background 0.35s ease;
        }
        /* æµ…è‰²ç±³ç™½ä¸»é¢˜ */
        .mind-bg.light {
            background: radial-gradient(ellipse at center, rgba(253,251,245,0.98), rgba(245,241,232,0.99));
        }
        /* æ·±è‰²å¤œé—´ä¸»é¢˜ */
        .mind-bg.dark {
            background: radial-gradient(ellipse at center, rgba(25,25,28,0.92), rgba(0,0,0,0.98));
        }

        .mind-shell {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flower-wrap{
    position:relative;
    width:min(72vw,360px);
    height:min(72vw,360px);
    display:flex;
    align-items:center;
    justify-content:center;
}

        /* èŠ±æœµå›¾ï¼šä¿æŒâ€œæ‰«æé¢—ç²’è´¨æ„Ÿâ€+æŸ”å…‰ */
      .flower-img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  transform-origin: center;
  animation: bloom 6s ease-in-out infinite;
  will-change: transform, opacity;

  /* PNG ä¸“ç”¨ï¼šè½»æŸ”ã€ä¸æŠ¢èƒŒæ™¯ */
  filter:
    saturate(1.02)
    brightness(1.02)
    drop-shadow(0 6px 14px rgba(150,120,100,.18));
}


        /* æ·±è‰²ä¸»é¢˜ä¸‹ï¼Œé˜´å½±ä¸äº®åº¦å¾®è°ƒï¼ˆä¸å½±å“æµ…è‰²ï¼‰ */
        .dark-theme .flower-img{
            filter: contrast(1.05) saturate(1.06) brightness(1.03) drop-shadow(0 10px 26px rgba(0,0,0,.35));
        }

        /* é¢—ç²’å å±‚ï¼šçº¸æ„Ÿ/ç²‰å°˜æ„Ÿ */
        .flower-grain{
  display: none;
}


        .dark-theme .flower-grain{
            mix-blend-mode: screen;
            opacity: .32;
        }

        .mind-text{
            position:absolute;
            bottom: -42px;
            left: 50%;
            transform: translateX(-50%);
            letter-spacing: .2em;
            font-size: 14px;
            user-select:none;
            transition: color .25s ease;
        }
        /* æ­£å¿µå€’è®¡æ—¶ */
.mind-timer{
    position: absolute;
    bottom: -68px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    letter-spacing: .15em;
    opacity: .55;
    user-select: none;
    transition: color .25s ease, opacity .25s ease;
}

.light-theme .mind-timer{
    color: rgba(90,70,60,.65);
}

.dark-theme .mind-timer{
    color: rgba(255,255,255,.55);
}

        .light-theme .mind-text { color: rgba(60,50,45,.75); }
        .dark-theme  .mind-text { color: rgba(255,255,255,.72); }

        .mind-top-left, .mind-top-right{
            position: absolute;
            top: 18px;
            font-size: 12px;
            letter-spacing: .12em;
            user-select: none;
            z-index: 10;
        }
        .mind-top-left{
            left: 18px;
        }
        .mind-top-right{
            right: 18px;
            display:flex;
            gap:10px;
            align-items:center;
        }

        .mind-btn{
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.25);
            background: rgba(255,255,255,.06);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            cursor: pointer;
            transition: transform .15s ease, opacity .15s ease;
            opacity: .85;
        }
        .mind-btn:hover{ transform: scale(1.03); opacity: 1; }

        .light-theme .mind-btn{
            border: 1px solid rgba(90,70,60,.22);
            background: rgba(255,255,255,.55);
        }
        .dark-theme .mind-btn{
            border: 1px solid rgba(255,255,255,.22);
            background: rgba(255,255,255,.06);
        }

        @keyframes bloom{
            0%   { transform: scale(.92); opacity:.92; }
            25%  { transform: scale(1.00); opacity:1; }
            50%  { transform: scale(1.07); opacity:1; }
            75%  { transform: scale(1.00); opacity:1; }
            100% { transform: scale(.92); opacity:.92; }
        }
        @keyframes grainMove{
            0%   { transform: translate3d(-1px,-1px,0); }
            50%  { transform: translate3d(1px,1px,0);  }
            100% { transform: translate3d(-1px,-1px,0); }
        }

        .hidden { display: none; }
    </style>
</head>

<body class="bg-stone-100">

    <!-- ğŸµ BGMï¼ˆä¸åŸé€»è¾‘å®Œå…¨è§£è€¦ï¼‰ -->
    <audio id="bgm" src="bgm.mp3" loop autoplay muted playsinline></audio>

    <div class="bg-main">

        <!-- ğŸµ å³ä¸Šè§’å£°éŸ³æŒ‰é’® -->
        <div id="soundToggle" class="sound-toggle">ğŸ”‡</div>

        <!-- é¦–é¡µ -->
        <div id="page-home" class="flex flex-col items-center gap-6 fade-in">
            <button onclick="showPage('input')" class="btn-pink px-10 py-4 rounded-lg text-xl font-medium tracking-widest shadow-lg">
                ï¼‹ ä»Šæ—¥è®°å½•
            </button>

            <!-- ä¸€åˆ†é’Ÿæ­£å¿µ -->
            <button onclick="startMindfulness()" class="text-white text-lg underline underline-offset-8 decoration-white/50 hover:text-white/80 transition-colors">
                ä¸€åˆ†é’Ÿå‘¼å¸
            </button>

            <button onclick="showHistory()" class="text-white text-lg underline underline-offset-8 decoration-white/50 hover:text-white/80 transition-colors">
                é˜…è§ˆå¾€æ˜”
            </button>
        </div>

        <!-- è¾“å…¥é¡µ -->
        <div id="page-input" class="hidden beige-modal fade-in">
            <p class="text-xl text-stone-700 mb-6 text-center font-medium">ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³ç•™ä¸‹çš„å—ï¼Ÿ</p>
            <textarea id="record-text"
                class="w-full h-40 bg-white/50 border border-stone-200 rounded p-4 focus:ring-1 focus:ring-stone-300 focus:outline-none text-stone-600 leading-relaxed resize-none mb-6"
                placeholder="åœ¨è¿™é‡Œå†™ä¸‹..." autofocus></textarea>

            <div class="flex flex-col items-center gap-4">
                <div class="flex gap-4 w-full">
                    <button onclick="showPage('home')" class="flex-1 py-3 text-stone-400 hover:text-stone-600 transition-colors">å–æ¶ˆ</button>
                    <button onclick="handleRecord()" class="flex-1 py-3 bg-stone-100 border border-stone-200 text-stone-600 rounded-lg hover:bg-stone-200 transition-all font-medium">å­˜å…¥</button>
                </div>
                <label class="flex items-center gap-2 text-stone-400 cursor-pointer text-xs mt-2">
                    <input type="checkbox" id="only-record" class="rounded border-stone-300"> åªè®°å½•ï¼Œä¸éœ€è¦å›åº”
                </label>
            </div>
        </div>

        <!-- åé¦ˆé¡µ -->
        <div id="page-feedback" class="hidden beige-modal fade-in text-center">
            <div id="animal-container" class="mb-6 flex justify-center text-5xl"></div>
            <div id="ai-response" class="text-lg leading-loose text-stone-600 italic px-2"></div>
            <button onclick="showPage('home')" class="mt-8 text-stone-400 hover:text-stone-600 underline text-sm">å›åˆ°é¦–é¡µ</button>
        </div>

        <!-- å†å²é¡µ -->
        <div id="page-history" class="hidden beige-modal fade-in max-h-[80vh] flex flex-col">
            <h2 class="text-center text-stone-500 mb-6 tracking-widest font-medium border-bottom border-stone-100 pb-2">â€” å¾€æ˜”è®°å½• â€”</h2>
            <div id="history-list" class="overflow-y-auto flex-1 pr-2 space-y-8 hide-scrollbar"></div>
            <button onclick="showPage('home')" class="mt-6 text-stone-400 hover:text-stone-600 text-sm">å…³é—­</button>
        </div>

    </div>

    <!--  æ­£å¿µå‘¼å¸ Overlayï¼ˆæµ…/æ·±ä¸»é¢˜å¯åˆ‡æ¢å¹¶è®°å¿†ï¼‰ -->
    <div id="mindfulness-overlay" class="hidden">
        <div id="mindBg" class="mind-bg"></div>

        <div id="mindThemeShell" class="mind-shell light-theme">
            <div class="mind-top-left">
                <span id="mindModeLabel" class="mind-btn">æ­£å¿µ Â· 60ç§’</span>
            </div>

            <div class="mind-top-right">
                <button id="themeToggleBtn" class="mind-btn" type="button">åˆ‡æ¢èƒŒæ™¯</button>
                <button id="mindExitBtn" class="mind-btn" type="button">é€€å‡º</button>
            </div>

            <div class="flower-wrap">
                <!-- ç¡®ä¿åŒç›®å½•å­˜åœ¨ flower.pngï¼ˆç”¨ä½ å‘çš„é‚£å¼ å›¾å³å¯ï¼‰ -->
                <img id="mindFlower" src="flower.png" alt="mind flower" class="flower-img" />
                <div class="flower-grain"></div>
                <div class="mind-text" id="mindText">å¸æ°”</div>
                 <div class="mind-timer" id="mindTimer">60</div>
        </div>
    </div>

    <script>
        /* ===================== ğŸµ BGMï¼ˆå®Œå…¨ç‹¬ç«‹ï¼Œä¸åˆ ä½ åŸé€»è¾‘ï¼‰ ===================== */
        const bgm = document.getElementById('bgm');
        const soundToggle = document.getElementById('soundToggle');
        const BGM_PREF_KEY = 'tree_hollow_bgm_muted';

        // è¯»å–ç”¨æˆ·åå¥½ï¼štrue=é™éŸ³ï¼Œfalse=å¼€å£°
        let userMuted = localStorage.getItem(BGM_PREF_KEY);
        userMuted = userMuted === null ? true : (userMuted === 'true');

        function updateSoundIcon() {
            soundToggle.innerText = userMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        }

        function setMuted(nextMuted) {
            userMuted = nextMuted;
            bgm.muted = userMuted;
            localStorage.setItem(BGM_PREF_KEY, String(userMuted));
            updateSoundIcon();
        }

        // é¡µé¢åŠ è½½ï¼šå°è¯•æ’­æ”¾ï¼ˆé™éŸ³æ›´å®¹æ˜“è¢«å…è®¸ï¼‰
        window.addEventListener('load', () => {
            bgm.volume = 0.55;
            bgm.muted = userMuted; // åº”ç”¨åå¥½
            updateSoundIcon();
            bgm.play().catch(()=>{});
        });

        // ç¬¬ä¸€æ¬¡ç”¨æˆ·äº¤äº’ï¼šå¦‚æœç”¨æˆ·å¹¶æœªé€‰æ‹©é™éŸ³ï¼Œåˆ™è‡ªåŠ¨å¼€å£°
        document.addEventListener('click', () => {
            if (!userMuted) {
                bgm.muted = false;
                updateSoundIcon();
            }
        }, { once: true });

        // æ‰‹åŠ¨å¼€å…³
        soundToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            setMuted(!userMuted);
            bgm.play().catch(()=>{});
        });

        /* =====================  æ­£å¿µå‘¼å¸ï¼ˆæµ…/æ·±ä¸»é¢˜åˆ‡æ¢å¹¶è®°å¿†ï¼‰ ===================== */
        const mindOverlay = document.getElementById('mindfulness-overlay');
        const mindBg = document.getElementById('mindBg');
        const mindShell = document.getElementById('mindThemeShell');
        const mindText = document.getElementById('mindText');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const mindExitBtn = document.getElementById('mindExitBtn');

        const MIND_THEME_KEY = 'tree_hollow_mind_theme'; // 'light' | 'dark'
        let mindTheme = localStorage.getItem(MIND_THEME_KEY) || 'light';

        function applyMindTheme(theme) {
            mindTheme = theme;
            localStorage.setItem(MIND_THEME_KEY, mindTheme);

            mindBg.classList.remove('light', 'dark');
            mindBg.classList.add(mindTheme);

            mindShell.classList.remove('light-theme', 'dark-theme');
            mindShell.classList.add(mindTheme === 'light' ? 'light-theme' : 'dark-theme');
        }

        applyMindTheme(mindTheme);

        let mindTimer = null;
let mindPhaseTimer = null;
let mindCountInterval = null; 


        function startMindfulness() {
            // æ‰“å¼€ overlay
            mindOverlay.classList.remove('hidden');
            applyMindTheme(mindTheme);

            // 60ç§’å‘¼å¸ç»“æ„ï¼šå¸10 åœ20 å‘¼20 å¾…10
            const phases = [
                { t: 10, label: "å¸æ°”" },
                { t: 20, label: "åœä¸€åœ" },
                { t: 20, label: "å‘¼æ°”" },
                { t: 10, label: "å°±è¿™æ ·å¾…ç€" },
            ];

            let i = 0;
            mindText.innerText = phases[0].label;

            function nextPhase() {
                if (i >= phases.length) return;
                mindText.innerText = phases[i].label;
                const dur = phases[i].t * 1000;
                i++;
                mindPhaseTimer = setTimeout(nextPhase, dur);
            }

            clearTimeout(mindTimer);
            clearTimeout(mindPhaseTimer);
            nextPhase();
// ===== 60 ç§’å€’è®¡æ—¶ =====
const timerEl = document.getElementById('mindTimer');
let remaining = 60;
timerEl.innerText = remaining;

// æ¸…ç†æ—§çš„ intervalï¼ˆé˜²æ­¢é‡å¤è¿›å…¥ï¼‰
clearInterval(mindCountInterval);

mindCountInterval = setInterval(() => {
    remaining--;
    timerEl.innerText = remaining;

    if (remaining <= 0) {
        clearInterval(mindCountInterval);
        mindCountInterval = null;
    }
}, 1000);

            mindTimer = setTimeout(() => stopMindfulness(), 60000);
        }

        function stopMindfulness() {
            mindOverlay.classList.add('hidden');
            clearTimeout(mindTimer);
            clearTimeout(mindPhaseTimer);
            clearInterval(mindCountInterval);

            mindTimer = null;
            mindPhaseTimer = null;
            mindCountInterval = null;
 
        }

        themeToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            applyMindTheme(mindTheme === 'light' ? 'dark' : 'light');
        });

        mindExitBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            stopMindfulness();
        });

        // é˜²æ­¢ overlay ç‚¹å‡»ç©¿é€å½±å“åº•å±‚é¦–æ¬¡äº¤äº’é€»è¾‘
        mindOverlay.addEventListener('click', (e) => {
            // ç‚¹èƒŒæ™¯ä¸é€€å‡ºï¼Œåªé˜»æ­¢ç©¿é€
            e.stopPropagation();
        });

        /* ===================== âœ… ä½ åŸæœ¬æ ‘æ´é€»è¾‘ï¼šä¿ç•™ + ä»…å¢å¼ºå›åº”è§„åˆ™ ===================== */
        const config = {
            joy: { animal: 'ğŸ¶', color: '#FCD34D' },
            anger: { animal: 'ğŸ¦', color: '#86EFAC' },
            sadness: { animal: 'ğŸ°', color: '#F9A8D4' },
            peace: { animal: 'ğŸ±', color: '#D1D5DB' },
            mixed: { animal: 'ğŸ»', color: '#D97706' }
        };

        function showPage(pageId) {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
        }

        function handleRecord() {
            const text = document.getElementById('record-text').value.trim();
            const onlyRecord = document.getElementById('only-record').checked;
            if (!text) return;

            const emotion = analyzeEmotion(text);
            const response = onlyRecord ? "" : getAIResponse(emotion, text);

            const history = JSON.parse(localStorage.getItem('tree_hollow_data') || '[]');
            history.unshift({
                content: text,
                date: new Date().toLocaleString('zh-CN', { month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' }),
                emotion: emotion,
                response: response
            });
            localStorage.setItem('tree_hollow_data', JSON.stringify(history));

            if (onlyRecord) {
                showPage('home');
            } else {
                renderFeedback(emotion, response);
            }
            document.getElementById('record-text').value = '';
        }

        function analyzeEmotion(text) {
            if (/(å¼€å¿ƒ|å¿«ä¹|æ£’|å“ˆå“ˆ|è°¢)/.test(text)) return "joy";
            if (/(æ°”|æ€’|ä¸å…¬|è®¨åŒ|å‡­ä»€ä¹ˆ|å§”å±ˆ)/.test(text)) return "anger";
            if (/(éš¾è¿‡|ç´¯|å“­|æ— èŠ|ç–²æƒ«|å¿ƒç¢)/.test(text)) return "sadness";
            if (/(å¹³æ·¡|è®°å½•|èŒ¶|äº‘|ç®€å•|å¹³å¸¸)/.test(text)) return "peace";
            return "mixed";
        }

        /* ============ ä¸ªæ€§åŒ–çŸ­å›åº”ï¼ˆè§„åˆ™å‡çº§ï¼Œä¸åˆ ä½ çš„æœºåˆ¶ï¼Œåªå¢å¼ºï¼‰ ============ */
        function getAIResponse(emotion, text) {
            const intensity =
                text.length < 18 ? 'light' :
                text.length < 70 ? 'medium' : 'heavy';

            const signals = {
                hasQuestion: /(\?|ï¼Ÿ)/.test(text),
                hasSigh: /(å”‰|å“|å””|ç®—äº†|ä¸æƒ³|æ‡’å¾—)/.test(text),
                hasNeedHug: /(æƒ³è¦|éœ€è¦|æŠ±æŠ±|å®‰æ…°|é™ªé™ª)/.test(text),
                hasSelfBlame: /(æ˜¯ä¸æ˜¯æˆ‘|éƒ½æ˜¯æˆ‘|æˆ‘ä¸å¥½|æˆ‘ä¸è¡Œ|æˆ‘å¤ª)/.test(text),
                hasOverwhelm: /(æ’‘ä¸ä½|å´©æºƒ|å—ä¸äº†|å¤ªéš¾äº†|å‹ä¸åŠ¨)/.test(text)
            };

            const bank = {
                joy: {
                    light: [
                        "æˆ‘æ”¶åˆ°è¿™ä¸€ç‚¹ç‚¹äº®å…‰äº†ã€‚æŠŠå®ƒç•™åœ¨è¿™é‡Œï¼Œå¥½å—ï¼Ÿ",
                        "ä»Šå¤©çš„ä½ å¾ˆå¯çˆ±ã€‚å°±è®©è¿™ä»½å¥½å¿ƒæƒ…å¤šå¾…ä¸€ä¼šå„¿ã€‚"
                    ],
                    medium: [
                        "è¿™ä»½å¼€å¿ƒå¾ˆçœŸå®ã€‚æˆ‘æ›¿ä½ æŠŠå®ƒå¥½å¥½æ”¶è—èµ·æ¥ã€‚",
                        "ä½ èƒ½æ„Ÿå—åˆ°å¿«ä¹ï¼Œè¯´æ˜ä½ åœ¨å¥½å¥½æ´»ç€ã€‚ç»§ç»­ä¿æŒã€‚"
                    ],
                    heavy: [
                        "ä½ æŠŠä¸€æ•´æ®µå…‰äº®éƒ½å¸¦æ¥äº†ã€‚åˆ«æ€¥ï¼Œè®©å®ƒæ…¢æ…¢ç…§ç€ä½ ã€‚",
                        "è¿™ä¹ˆå¤šå–œæ‚¦å†™ä¸‹æ¥å¾ˆçè´µã€‚ä»¥åå›çœ‹ï¼Œä¼šå¾ˆæ¸©æŸ”ã€‚"
                    ]
                },
                anger: {
                    light: [
                        "ä½ æœ‰æƒä¸èˆ’æœã€‚ä½ çš„è¾¹ç•Œæ˜¯å€¼å¾—è¢«å°Šé‡çš„ã€‚",
                        "æˆ‘å¬åˆ°äº†ã€‚ä½ ä¸éœ€è¦ç«‹åˆ»å˜å¾—â€œæ‡‚äº‹â€ã€‚"
                    ],
                    medium: [
                        "è¿™ä»½æ„¤æ€’åƒæ˜¯åœ¨ä¿æŠ¤ä½ ã€‚ä½ æ­£åœ¨ä¸ºè‡ªå·±ç«™å‡ºæ¥ã€‚",
                        "ä½ ä¸æ˜¯æ— ç†å–é—¹ï¼Œä½ æ˜¯åœ¨æå«è‡ªå·±çš„æ„Ÿå—ã€‚"
                    ],
                    heavy: [
                        "æˆ‘å¬è§ä½ åœ¨å¼ºçƒˆåœ°è¯´ï¼šè¿™ä¸åº”è¯¥å‘ç”Ÿåœ¨æˆ‘èº«ä¸Šã€‚",
                        "å…ˆåˆ«æ€¥ç€è®²é“ç†ã€‚ä½ å¯ä»¥å…ˆæŠŠç«æ”¾åœ¨è¿™é‡Œï¼Œæˆ‘æ›¿ä½ çœ‹ç€ã€‚"
                    ]
                },
                sadness: {
                    light: [
                        "æˆ‘åœ¨ã€‚ä½ ä¸éœ€è¦æŠŠè¯è¯´å®Œï¼Œä¹Ÿæ²¡å…³ç³»ã€‚",
                        "å°±ç®—åªå†™è¿™ä¸€ç‚¹ç‚¹ï¼Œæˆ‘ä¹Ÿä¼šè®¤çœŸæ¥ä½ã€‚"
                    ],
                    medium: [
                        "è¿™äº›éš¾è¿‡ä¸æ˜¯ä½ çš„é”™ã€‚ä½ å·²ç»å¾ˆåŠªåŠ›äº†ã€‚",
                        "ä½ å¯ä»¥æ…¢ä¸€ç‚¹ã€‚æƒ…ç»ªä¸éœ€è¦è¢«å‚¬ä¿ƒã€‚"
                    ],
                    heavy: [
                        "è¿™äº›è¯ä¸€å®šåœ¨ä½ å¿ƒé‡Œå‹äº†ä¸€ä¼šå„¿äº†ã€‚ä½ èƒ½å†™å‡ºæ¥å¾ˆä¸å®¹æ˜“ã€‚",
                        "æˆ‘åœ¨è¿™é‡Œã€‚ä½ ä¸ç”¨ç«‹åˆ»å¥½èµ·æ¥ï¼Œæˆ‘ä»¬å…ˆä¸€èµ·å‘¼ä¸€å£æ°”ã€‚"
                    ]
                },
                peace: {
                    light: [
                        "å—¯ï¼Œæˆ‘åœ¨å¬ã€‚å¹³é™æœ¬èº«å°±æ˜¯ä¸€ç§åŠ›é‡ã€‚",
                        "è¿™æ ·è½»è½»åœ°è®°å½•ï¼Œä¹Ÿå¾ˆå¥½ã€‚"
                    ],
                    medium: [
                        "ä½ åœ¨è®¤çœŸç”Ÿæ´»çš„ç¼éš™é‡Œï¼Œç»™è‡ªå·±ç•™äº†ä¸€ä¸ªä½ç½®ã€‚",
                        "è¿™ä¸€åˆ»å¾ˆå®‰é™ï¼Œä½†ä¸ç©ºã€‚å®ƒåœ¨æ…¢æ…¢æ»‹å…»ä½ ã€‚"
                    ],
                    heavy: [
                        "ä½ æŠŠæ—¥å¸¸å†™å¾—å¾ˆå®Œæ•´ã€‚ä½ åœ¨ç»™è‡ªå·±æ­ä¸€ä¸ªå®‰å…¨çš„å®¶ã€‚",
                        "è¿™ä»½å¹³é™åƒä¸€ç›å°ç¯ã€‚å®ƒä¸ä¼šè½°è½°çƒˆçƒˆï¼Œä½†ä¼šä¸€ç›´äº®ã€‚"
                    ]
                },
                mixed: {
                    light: [
                        "å¥½å¤æ‚ï¼Œä½†æ²¡å…³ç³»ã€‚ä½ å¯ä»¥åªæŠŠä¸€å°ç‰‡æ”¾è¿›æ¥ã€‚",
                        "ä¸ç”¨ç†æ¸…é¡ºåºã€‚æŠŠå®ƒå€’å‡ºæ¥å°±å¥½ã€‚"
                    ],
                    medium: [
                        "æˆ‘å¬è§äº†çŸ›ç›¾ä¸æ‹‰æ‰¯ã€‚å®ƒä»¬å¹¶ä¸è¯´æ˜ä½ è„†å¼±ã€‚",
                        "ä½ æ­£åœ¨ç»å†å¾ˆå¤šå±‚çš„æ„Ÿå—ã€‚æˆ‘ä»¬å…ˆæ…¢ä¸€ç‚¹ã€‚"
                    ],
                    heavy: [
                        "è¿™ä¹ˆå¤šä¸œè¥¿åŒæ—¶å‹ç€ä½ ï¼ŒçœŸçš„ä¼šå¾ˆç´¯ã€‚æˆ‘åœ¨è¿™é‡Œé™ªä½ æ”¾ä¸€æ”¾ã€‚",
                        "ä½ ä¸éœ€è¦ä¸€ä¸ªäººæŠŠæ‰€æœ‰éƒ½æ‰›ä½ã€‚å…ˆæŠŠé‡é‡äº¤ç»™æ ‘æ´ä¸€ç‚¹ç‚¹ã€‚"
                    ]
                }
            };

            // åŸºç¡€å¥ï¼ˆæŒ‰æƒ…ç»ªÃ—å¼ºåº¦ï¼‰
            const baseList = (bank[emotion] && bank[emotion][intensity]) ? bank[emotion][intensity] : ["æˆ‘åœ¨è¿™é‡Œã€‚ä½ å¯ä»¥æ…¢æ…¢è¯´ã€‚"];
            let line1 = pick(baseList);

            // è½»å¾®ä¸ªæ€§åŒ–è¡¥å……ï¼ˆä¸åˆ†æåŸå› ã€ä¸å†’çŠ¯ï¼‰
            let line2 = "";
            if (signals.hasSelfBlame) line2 = "åˆ«æ€¥ç€è´£æ€ªè‡ªå·±ã€‚ä½ å·²ç»åœ¨å°½åŠ›äº†ã€‚";
            else if (signals.hasOverwhelm) line2 = "å¦‚æœç°åœ¨å¾ˆæ»¡ï¼Œå°±å…ˆåšä¸€ä»¶å¾ˆå°çš„äº‹ï¼šæŠŠè‚©è†€æ”¾æ¾ä¸€ä¸‹ã€‚";
            else if (signals.hasNeedHug) line2 = "ç»™ä½ ä¸€ä¸ªå¾ˆè½»çš„æŠ±æŠ±ï¼ˆå¦‚æœä½ æ„¿æ„ï¼‰ã€‚";
            else if (signals.hasQuestion) line2 = "ä½ ä¸éœ€è¦ç«‹åˆ»æ‰¾åˆ°ç­”æ¡ˆã€‚å…ˆå…è®¸è‡ªå·±åœåœ¨è¿™é‡Œã€‚";
            else if (signals.hasSigh) line2 = "ä½ å¯ä»¥å…ˆä¸ç”¨â€œè§£å†³â€ã€‚å…ˆè¢«ç†è§£å°±å¤Ÿäº†ã€‚";

            // å¾®è¡ŒåŠ¨ï¼ˆå¯é€‰ã€æå°ï¼‰
            const microActions = {
                joy:    ["æŠŠæ‰‹æ”¾åœ¨èƒ¸å£ï¼Œæ„Ÿå—ä¸€ä¸‹è¿™ä»½æš–ã€‚", "è½»è½»ç¬‘ä¸€ä¸‹å°±å¥½ã€‚"],
                anger:  ["æ…¢æ…¢å‘¼æ°”ä¸€æ¬¡ï¼ŒæŠŠä¸‹å·´æ”¾æ¾ã€‚", "æ¡ç´§å†æ¾å¼€æ‹³å¤´ä¸€æ¬¡ã€‚"],
                sadness:["æŠŠè‚©è†€æ”¾ä¸‹æ¥ï¼Œå‘¼ä¸€å£é•¿æ°”ã€‚", "å–ä¸€å£æ°´ä¹Ÿç®—ç…§é¡¾è‡ªå·±ã€‚"],
                peace:  ["çœ¨çœ¨çœ¼ï¼Œçœ‹çœ‹æ­¤åˆ»ä½ èº«è¾¹çš„å…‰ã€‚", "å…è®¸è‡ªå·±è¿™æ ·å®‰é™ä¸€ä¼šå„¿ã€‚"],
                mixed:  ["å…ˆé€‰ä¸€ä¸ªè¯å½¢å®¹ç°åœ¨ï¼šç´§/ä¹±/ç´¯/ç©ºã€‚", "é—­çœ¼ä¸‰ç§’ï¼Œå†å›æ¥ã€‚"]
            };
            const action = pick(microActions[emotion] || ["å…ˆå‘¼ä¸€å£æ°”ã€‚"]);

            // ç»„åˆè¾“å‡ºï¼ˆçŸ­ã€æ²»æ„ˆã€ä¸è¯´æ•™ï¼‰
            const parts = [line1];
            if (line2) parts.push(line2);
            parts.push(action);

            return parts.join("\n");
        }

        function pick(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function renderFeedback(emotion, response) {
            document.getElementById('animal-container').innerText = config[emotion].animal;
            document.getElementById('ai-response').innerText = response;
            showPage('feedback');
        }

        function showHistory() {
            const history = JSON.parse(localStorage.getItem('tree_hollow_data') || '[]');
            const list = document.getElementById('history-list');

            list.innerHTML = history.length === 0
                ? `<p class="text-center text-stone-300 italic py-10">è¿™é‡Œè¿˜æ˜¯ç©ºçš„ã€‚</p>`
                : history.map(item => `
                    <div class="border-l-2 border-stone-200 pl-4 py-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-lg">${config[item.emotion].animal}</span>
                            <span class="text-[10px] text-stone-300 uppercase">${item.date}</span>
                        </div>
                        <p class="text-stone-600 text-sm mb-2">${item.content}</p>
                        ${item.response ? `<div class="text-[12px] text-stone-400 italic bg-stone-50 p-2 rounded whitespace-pre-line">æ ‘æ´ï¼š${item.response}</div>` : ''}
                    </div>
                `).join('');
            showPage('history');
        }
    </script>
</body>
</html>
